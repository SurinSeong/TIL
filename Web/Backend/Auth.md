# Authentication System

## Cookie & Session

### HTTP

- HTML 문서와 같은 리소스들을 가져올 수 있도록 해주는 규약
- 웹(WWW)에서 이루어지는 모든 데이터 교환의 기초
- 특징
    1. **비연결 지향 (connectionless)**
        - 서버는 요청에 대한 응답을 보낸 후 연결을 끊음
    2. **무상태 (stateless)**
        - 연결을 끊는 순간 클라이언트와 서버 간의 통신이 끝나며 상태 정보가 유지되지 않는다.
            - 상태 정보 유지 X = 로그인 상태 유지 불가능

### Cookie (쿠키)

- **브라우저**에서 관리한다.
- **서버가 사용자 웹 브라우저에 전송**하는 작은 데이터 조각
    - 서버가 제공하여 클라이언트 측에서 저장되는 작은 데이터 파일
    - 사용자 인증, 추적, 상태 유지 등에 사용되는 데이터 저장 방식
- 동작 예시
    1. 브라우저가 웹 **서버에** 웹 **페이지를 요청**
    2. 웹 서버는 **요청된 페이지**와 함께 **쿠키를 포함한 응답**을 브라우저에게 전송
    3. 브라우저는 받은 **쿠키를 저장소에 저장**, **쿠키의 속성(만료 시간, 도메인, 주소 등)** 도 함께 저장됨.
    4. 이후 브라우저가 같은 웹 서버에 웹 페이지를 요청할 때, **저장된 쿠키 중 해당 요청에 적용 가능한 쿠키를 포함하여 함께 전송**
    5. 웹 서버는 받은 **쿠키 정보를 확인**하고, 필요에 따라 **사용자 식별, 세션 관리** 등을 수행
    6. 웹 서버는 요청에 대한 응답을 보내며, 필요한 경우 **새로운 쿠키를 설정하거나 기존 쿠키를 수정**할 수 있음.
- 쿠키의 작동원리와 활용
    1. 쿠키 저장 방식
        - 브라우저(클라이언트)는 쿠키를 **key-value의 데이터 형식**으로 저장
        - 쿠키에는 이름, 값 외에도 **만료 시간, 도메인, 경로** 등의 추가 속성이 포함됨
    2. 쿠키 전송 과정
        - 서버는 HTTP 응답 헤더의 **Set-Cookie 필드**를 통해 클라이언트에게 쿠키를 전송
        - 브라우저는 받은 쿠키를 저장해두었다가, **동일한 서버에 재요청 시 HTTP 요청**, **Header의 Cookie 필드에 저장된 쿠키를 함께 전송**
    3. 쿠키의 주요 용도
        - **두 요청이 동일한 브라우저에서 들어왔는지 아닌지**를 판단할 때 주로 사용됨.
        - 이를 이용해 사용자의 **로그인 상태를 유지**할 수 있음.
        - 상태가 없는 HTTP 프로토콜에서 상태 정보를 기억시켜 주는 역할
        - ⇒ 서버에게 사용자 인증 정보가 담긴 쿠키를 **매 요청마다 계속 보내는 것**
- 쿠키 사용 목적
    1. 세션 관리 (Session management)
        - 로그인, 아이디 자동완성, 공지 하루 안보기, 팝업 체크, 장바구니 등의 정보 관리
    2. 개인화 (Personalization)
        - 사용자 선호 설정 (언어 설정, 테마 등) 저장
    3. 트래킹 (Tracking)
        - 사용자 행동을 기록 및 분석

### Session (세션)

- 서버 측에서 생성되어 **클라이언트와 서버 간의 상태를 유지**
    - 세션 데이터는 쿠키에 담겨있음.
- **상태 정보를 저장**하는 데이터 저장 방식
- ⇒ 쿠키에 세션 데이터를 저장하여 매 요청시마다 세션 데이터를 함께 보냄
- 작동 원리
    1. 클라이언트가 로그인 요청 후 인증에 성공하면 서버가 **session 데이터(사용자 인증 정보)를 생성 후 저장**
    2. 생성된 session 데이터에 인증할 수 있는 **session id를 발급**
    3. 발급한 session id 를 클라이언트에게 응답 (**데이터는 서버에 저장하고 id 만 준다**.)
    4. 클라이언트는 응답 받은 session id 를 쿠키에 저장한다.
    5. 클라이언트가 다시 동일한 서버에 접속하면 요청과 함께 쿠키 (session id가 저장된) 를 서버에 전달
    6. **쿠키는 요청 때마다 서버에 함께 전송**되기 때문에 서버에서 session id 를 확인해 로그인되어 있다는 것을 계속 확인하게 한다.

### 서버 측에서는 **세션 데이터를 생성 후 저장**하고, 이 데이터에 접근할 수 있는 세션 ID를 생성한다.
이 ID를 클라이언트 측으로 전달하고, 클라이언트는 쿠키에 이 ID를 저장한다.
이후, 클라이언트가 같은 서버에 재요청 시마다 저장해두었던 쿠키도 요청과 함께 전송한다.

- 쿠키와 세션의 목적
    - 클라이언트와 서버 간의 상태 정보를 유지하고 사용자를 식별하기 위해 사용

## Django Authentication System

- 사용자 인증과 관련된 기능을 모아 놓은 시스템

### Custom User Model

- 기본 User Model의 한계
    - 별도의 User 클래스 정의 없이 내장된 auth 앱에 작성된 User 클래스를 사용함.
    - Django의 기본 User 모델은 username, password등 제공되는 필드가 제한적이다.
    - 추가적인 사용자 정보가 필요하다면 이를 위해 기본 User Model을 변경하기 어렵다.
- 내장된 auth 앱
    - ‘django.contrib.auth’
- User model 대체 필요성
    - 프로젝트의 특정 요구 사항에 맞춰 사용자 모델을 확장할 수 있다.
    - 예를 들어, 이메일을 username으로 사용하거나, 다른 추가 필드를 포함시킬 수 있다.
- Custom User Model 로 대체하기
    1. AbstractUser 클래스를 상속 받는 커스텀 User 클래스 작성
        - 기존 User 클래스도 AbstractUser를 상속 받기 때문에 **커스텀 User 클래스도 기존 User 클래스와 완전히 같은 모습을 가지게 된다.**
    2. django 프로젝트에서 사용하는 기본 User 모델을 우리가 작성한 User 모델로 사용할 수 있도록 AUTH_USER_MODEL 값 변경
        - AUTH_USER_MODEL : Django 프로젝트의 User 를 나타내는 데 사용하는 모델을 지정하는 속성
    3. admin site에 대체한 User 등록

### 프로젝트 중간에 AUTH_USER_MODEL 변경 불가능!!

## Login

- 세션을 Create 하는 과정
- AuthenticationForm() : 로그인 인증에 사용할 데이터를 입력받는 **built-in form**
- login(request, user) : AuthenticationForm을 통해 **인증된 사용자를 로그인** 하는 함수
- get_user() : AuthenticationForm의 인스턴스 메서드
    - **유효성 검사**를 **통과**했을 경우, **로그인한 사용자 객체 반환**

## Logout

- 세션을 delete 하는 과정
- logout(request)
    1. DB에서 현재 요청에 대한 Session data를 삭제한다.
    2. 클라이언트의 쿠키에서도 Session id를 삭제한다.

## Template with Authentication data

### 템플릿과 인증 데이터

- 템플릿에서 인증 관련 데이터를 출력하는 방법
- 현재 로그인 되어 있는 유저 정보를 사용할 수 있는 이유는?
    - django가 미리 준비한 context 데이터가 존재하기 때문
    - context processor
        - 템플릿이 렌더링될 때 호출 가능한 컨텍스트 데이터 목록
        - 작성된 컨텍스트 데이터는 기본적으로 템플릿에서 사용 가능한 변수로 포함됨
            - django에서 자주 사용하는 데이터 목록을 미리 템플릿에 로드해 둔 것
