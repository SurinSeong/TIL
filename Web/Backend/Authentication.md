# Authentication

## Cookie & Session

- 우리가 서버로부터 받은 페이지를 둘러볼 때, 우리는 서버와 **서로 연결되어 있는 상태가 아님**
- HTTP
    - HTML 문서와 같은 리소스들을 가져올 수 있도록 해주는 규약
        - 웹에서 이루어지는 모든 데이터 교환의 기초
    - 특징
        - **비연결지향 (connectionless)** : 서버는 요청에 대한 응답을 보낸 후 연결을 끊음
        - **무상태 (stateless)** : 연결을 끊는 순간, 클라이언트와 서버 간의 통신이 끝나며 상태 정보가 유지 되지 않는다.
        - ⇒ **상태를 유지**하기 위한 기술이 필요하다.

### 쿠키

- 서버가 사용자의 **웹 브라우저에 전송하는 작은 데이터 조각**
    - 클라이언트 측에서 저장되는 **작은 데이터 파일**이며, **사용자 인증, 추적, 상태 유지** 등에 사용되는 데이터 저장 방식
- 사용 예시
    1. 브라우저는 서버에게 페이지를 요청한다.
    2. 서버는 페이지와 쿠키를 전송한다.
    3. 브라우저는 같은 서버에게 다른 페이지를 요청한다. 이때, 저장해 놓았던 쿠키를 함께 전송한다.
- 원리
    1. 브라우저 (클라이언트)는 쿠키를 **Key-Value의 데이터 형식**으로 저장한다. (Key : 어떤 데이터가 저장되어 있을까? / Value : 서버에게 요청을 보냈을 때 필요로 하는 데이터)
    2. 이렇게 쿠키를 저장해두었다가, **동일한 서버에 재요청 시 저장된 쿠키를 함께 전송**한다.
        
        ⇒ 쿠키는 두 요청이 **동일한 브라우저에서 들어왔는지 아닌지**를 판단할 때 주로 사용된다.
        
        - 이를 이용해서 사용자의 **로그인 상태를 유지**할 수 있다.
        - 상태가 없는 HTTP 프로토콜에서 **상태 정보를 기억**시켜주기 때문이다.
- 목적
    1. 세션 관리 (Session management)
        - 로그인, 아이디 자동완성, 공지 하루 안보기, 팝업 체크, 장바구니 등의 정보 관리
    2. 개인화 (Personalization)
        - 사용자 선호, 테마 등의 설정
        - Mute 상태 유지, 영상 중단 구간 기억
    3. 트래킹 (Tracking)
        - 사용자 행동을 기록 및 분석

### Sesson

- 서버 측에서 생성되어 클라이언트와 서버 간의 상태를 유지
- 상태 정보를 저장하는 데이터 저장 방식

⇒ 쿠키에 세션 데이터를 저장하여 매 요청 시마다 세션 데이터를 함께 보낸다.

- 작동 원리
    1. 클라이언트가 로그인을 하면 서버가 session 데이터를 생성 후 저장
    2. 생성된 session 데이터에 인증할 수 있는 **session id(고유값)**를 발급
    3. 발급한 session id를 클라이언트에게 응답
    4. 클라이언트는 응답을 받은 session id를 쿠키에 저장
    5. 클라이언트가 다시 동일한 서버에 접속하면 요청과 함께 **쿠키를 서버에 전달**
    6. 쿠키는 **요청 때마다 서버에 함께 전송**되기 때문에 서버에서 session id를 확인해 로그인 되어 있다는 것을 알도록 한다.

**서버 측에서는 세션 데이터를 생성 후 저장하고 이 데이터에 접근할 수 있는 세션 ID를 생성한다.**

**이 ID를 클라이언트 측으로 전달하고, 클라이언트는 쿠키에 이 ID를 저장한다.**

**이후, 클라이언트가 같은 서버에 재요청 시마다 저장해두었던 쿠키도 요청과 함께 전송**한다.

⇒ 예를 들어, 로그인 상태 유지를 위해 로그인 되어있다는 사실을 입증하는 데이터를 매 요청마다 계속해서 보내는 것

- 쿠키와 세션의 목적
    - 서버와 클라이언트 간의 ‘상태’를 유지

- 쿠키 종류별 Lifetime (수명)
    1. Session cookie
        - 현재 세션(current session)이 종료되면 삭제됨
        - 브라우저 종료와 함께 세션이 삭제됨
    2. Persistent cookies
        - Expires 속성에 지정된 날짜 혹은 Max-Age 속성에 지정된 기간이 지나면 삭제됨

- 세션 in Django
    - ‘database-backend sessions’ 저장 방식을 기본값으로 사용
    - session 정보는 DB의 django_session 테이블에 저장됨
    - Django는 요청 안에 특정 session id를 포함하는 쿠키를 사용해서 각각의 브라우저와 사이트가 연결된 session 데이터를 알아냄
    - Django는 우리가 session 메커니즘에 대부분을 생각하지 않게끔 많은 도움을 준다.

## Authentication with DRF

- `AbstractUser` : django 제공
    - 유저에게 필요로 하는 모든 정보 제공함.
        - username
        - firstname, lastname
        - email
        - is_staff (관리자인지)
        - is_active(활성화상태)
        - date_joined(마지막 로그인 상태)
        - password 비밀번호 설정 >> 암호화를 적용해준다.
        - last_login

### Authentication 인증

- 수신된 요청을 해당 요청의 사용자 또는 자격 증명과 연결하는 메커니즘 >> 누구인지 확인!

### Permissions 권한

- 요청에 대한 접근 허용 또는 거부 여부를 결정

### 인증과 권한

- 순서 상 **인증이 먼저 진행**되며 수신 요청을 해당 요청의 사용자 또는 해당 요청이 서명된 토큰 (token)과 같은 **자격 증명 자료와 연결**
- 그런 다음, 권한 및 제한 정책은 **인증이 완료된 해당 자격 증명을 사용하여 요청을 허용**해야 하는지를 결정

### DRF에서의 인증

- 인증은 항상 view 함수 시작 시, 권한 및 제한 확인이 발생하기 전, 다른 코드의 진행이 허용되기 전에 실행된다.
    - 인증 자체로는 들어오는 요청을 허용하거나 거부할 수 없다. **단순히 요청에 사용된 자격 증명만 식별**한다.

- TokenAuthentication
    - **token 기반** HTTP 인증 체계
    - 기본 데스크톱 및 모바일 클라이언트와 같은 클라이언트-서버 설정에 적합
        
        ⇒ 서버가 인증된 사용자에게 **토큰을 발급**하고 사용자는 매 요청마다 **발급받은 토큰을 요청과 함께 보내** 인증 과정을 거침
        

### Token 인증 설정

- TokenAuthentication 적용 과정
    1. 인증 클래스 설정
    2. INSTALLED_APPS 추가
    3. Migrate 진행
    4. 토큰 생성 코드 작성

- Dj-Rest-Auth
    - 회원가입, 인증, 비밀번호 재설정, 사용자 세부 정보 검색, 회원 정보 수정 등 **다양한 인증 관련 기능을 제공**하는 라이브러리
- Dj-Rest-Auth의 Registration (등록) 기능 추가 설정
    1. 패키지 추가 설치
        
        `$ pip install dj-rest-auth[with-social]`
        
    2. 추가 App 등록
    3. 추가 URL 등록
    4. Migrate
